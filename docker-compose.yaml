version: '2.4'

services: 

##### CROSSBAR #####

  crossbar: 
    image: crescent-crossbar
    expose:
      - ${CROSSBAR_PORT}
 #   environment:
 #     HOST: ${HOST}
 #     SERVER_PORT: ${SERVER_PORT}
    ports:
      - ${CROSSBAR_PORT}:${CROSSBAR_PORT}
#    volumes:
#      - ./src
#    command: crossbar start --cbdir /crossbarnode/.crossbar


##### MONGO ####

  mongo: 
    image: suluxan/mongo
    expose:
      - ${MONGO_PORT}
#    environment:
#      HOST: ${HOST}
#      SERVER_PORT: ${SERVER_PORT}
    ports:
      - ${MONGO_PORT}:${MONGO_PORT}
   volumes:
     - ./mongodb:/data/db
    depends_on:
      - crossbar
#      - type: bind
#      source: ./mongodb
#      target: /data/db
#    command: mongod

##### MINIO #####

  minio: 
    image: minio/minio
    expose:
      - ${MINIO_PORT}
 #   environment:
 #     HOST: ${HOST}
 #     SERVER_PORT: ${SERVER_PORT}
    ports:
      - ${MINIO_PORT}:${MINIO_PORT}
    environment:
      MINIO_ACCESS_KEY: crescent-access
      MINIO_SECRET_KEY: crescent-secret
    depends_on:
      - crossbar
    command: server ./express/tmp/minio
#    volumes:
#      - ./src

##### NODE ####

  server: 
    # build:
    #   context: ./
    #   dockerfile: Dockerfile.server
    image: express-test-singularity
    privileged: true
    expose:
      - ${SERVER_PORT}
      - ${GRAPHQL_PORT}
#    environment:
#      HOST: ${HOST}
#      SERVER_PORT: ${SERVER_PORT}
    ports:
      - ${SERVER_PORT}:${SERVER_PORT}
      - ${GRAPHQL_PORT}:${GRAPHQL_PORT}
    volumes:
      - .:/usr/src/app
    #  - /var/run/docker.sock:/var/run/docker.sock
    depends_on:
      - crossbar
      - minio 
      - mongo
    #mem_limit: 20g
    command: npm run server

##### REACT #####
  react: 
    image: react-test-plotly
    expose:
      - ${REACT_PORT}
#    environment:
#      HOST: ${HOST}
#      SERVER_PORT: ${SERVER_PORT}
    ports:
      - ${REACT_PORT}:${REACT_PORT}
    volumes:
      - .:/usr/src/app
    depends_on:
      - crossbar
      - server
    command: npm run start


